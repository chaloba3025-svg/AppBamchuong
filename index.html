<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APP BẤM CHUÔNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #main-container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        /* App Title */
        #app-title {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #app-title h1 {
            font-size: 1.5em;
            margin: 0;
            font-weight: bold;
        }
        /* Buttons */
        #control-panel button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            margin: 5px;
        }
        /* Giao diện chọn chức năng theo cột dọc */
        #start-view {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Tạo phòng button */
        #createRoomBtn {
            background-color: #28a745;
            width: 150px;
            height: 150px;
            border-radius: 0;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }
        /* Vào phòng button */
        #joinRoomBtn {
            background-color: #007bff;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
        }
        #countdown-display {
            font-size: 4em;
            font-weight: bold;
            color: #dc3545;
            margin-top: 20px;
        }
        #buzzer-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #fff;
            background-color: #dc3545;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        #buzzer-button.disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .buzzer-blue {
            background-color: #007bff !important;
        }
        .buzzer-green {
            background-color: #28a745 !important;
        }
        #results-panel {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        #results-panel h2 {
            color: #555;
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        #results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #results-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
            display: flex;
            justify-content: space-between;
        }
        #results-list li:last-child {
            border-bottom: none;
        }
        .player-rank {
            font-weight: bold;
        }
        .player-time {
            color: #888;
        }
        /* Nút quay về trang chủ */
        #homeButton {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #homeButton::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 25px;
            border: 3px solid #dc3545;
            border-top: none;
            border-radius: 5px 5px 0 0;
        }
        #homeButton::after {
            content: '';
            position: absolute;
            top: 8px;
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 15px solid #dc3545;
        }

        /* Các lớp CSS để ẩn/hiện giao diện */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="homeButton" class="hidden"></div>
        
        <div id="app-title">
            <h1>APP BẤM CHUÔNG</h1>
        </div>

        <div id="start-view">
            <button id="createRoomBtn">TẠO</button>
            <button id="joinRoomBtn">VÀO</button>
        </div>

        <div id="master-view" class="hidden">
            <h1>Mã phòng: <span id="roomCodeDisplay"></span></h1>
            <div id="control-panel">
                <button id="playButton">PLAY</button>
            </div>
            <div id="countdown-display" class="hidden"></div>
        </div>

        <div id="player-view" class="hidden">
            <h1>Sẵn sàng!</h1>
            <div id="buzzer-button">
                BẤM
            </div>
        </div>

        <div id="results-panel" class="hidden">
            <h2>Kết quả:</h2>
            <ul id="results-list">
                </ul>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Khởi tạo Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAAdt8pjiOTBCFuDEv_1BWZlPQYtJBWdZY",
            authDomain: "appchuong-c3fb8.firebaseapp.com",
            projectId: "appchuong-c3fb8",
            storageBucket: "appchuong-c3fb8.firebasestorage.app",
            messagingSenderId: "794046720932",
            appId: "1:794046720932:web:8fe3166394b7e366dbaf31",
            measurementId: "G-1W7BYFTQNX"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const startView = document.getElementById('start-view');
        const masterView = document.getElementById('master-view');
        const playerView = document.getElementById('player-view');
        const resultsPanel = document.getElementById('results-panel');
        const playButton = document.getElementById('playButton');
        const buzzerButton = document.getElementById('buzzer-button');
        const resultsList = document.getElementById('results-list');
        const countdownDisplay = document.getElementById('countdown-display');
        const countdownDisplayPlayer = document.getElementById('countdown-display-player');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const homeButton = document.getElementById('homeButton');
        
        const audio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        let audioPlayCount = 0;
        let roomListenerUnsubscribe;

        let isMaster = false;
        let myName = '';
        let currentRoomCode = '';
        let isPressed = false;

        // Hàm tạo mã phòng ngẫu nhiên 1 chữ số
        const generateRoomCode = () => {
            return Math.floor(Math.random() * 9) + 1;
        };

        // Hàm lắng nghe sự thay đổi của phòng
        const listenToRoom = (roomCode) => {
            const roomRef = db.collection('rooms').doc(roomCode.toString());
            roomListenerUnsubscribe = roomRef.onSnapshot(async (doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // Kiểm tra nếu có lệnh reset từ máy chủ
                    if (data.reset) {
                        // Nếu là máy chủ, đặt lại cờ reset để không bị lặp vô hạn
                        if (isMaster) {
                            await roomRef.update({ reset: false });
                        }
                        resetToStartView();
                        return;
                    }

                    const pressTimes = data.press_times || [];
                    const status = data.status;
                    const countdown = data.countdown;

                    // Hiển thị và ẩn đồng hồ đếm ngược
                    if (countdown >= 0) {
                        countdownDisplay.textContent = countdown === 0 ? 'HẾT!' : countdown;
                        countdownDisplayPlayer.textContent = countdown === 0 ? 'HẾT!' : countdown;
                        countdownDisplay.classList.remove('hidden');
                        countdownDisplayPlayer.classList.remove('hidden');
                    } else {
                        countdownDisplay.classList.add('hidden');
                        countdownDisplayPlayer.classList.add('hidden');
                    }
                    
                    // Cập nhật trạng thái nút bấm
                    if (status === 'active' && countdown <= 0 && !isMaster) {
                        buzzerButton.classList.remove('disabled');
                    } else {
                        buzzerButton.classList.add('disabled');
                    }
                    
                    // Sắp xếp theo thời gian bấm sớm nhất
                    pressTimes.sort((a, b) => a.pressTime - b.pressTime);
                    
                    // Xóa danh sách cũ
                    resultsList.innerHTML = '';
                    
                    // Hiển thị danh sách mới
                    pressTimes.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="player-rank">#${index + 1}. ${item.playerName}</span> <span class="player-time">${new Date(item.pressTime).toLocaleTimeString()}</span>`;
                        resultsList.appendChild(li);
                        
                        if (index === 0 && item.playerName === myName) {
                            buzzerButton.style.backgroundColor = '#28a745';
                            // Phát âm thanh 5 lần rồi dừng
                            if (audioPlayCount < 5) {
                                if (audio.paused) {
                                    audio.play();
                                }
                                audio.onended = () => {
                                    audioPlayCount++;
                                    if (audioPlayCount < 5) {
                                        audio.play();
                                    } else {
                                        audioPlayCount = 0;
                                    }
                                };
                            }
                        }
                    });
                }
            });
        };

        // Hàm reset về màn hình ban đầu
        const resetToStartView = () => {
            if (roomListenerUnsubscribe) {
                roomListenerUnsubscribe();
            }
            isMaster = false;
            myName = '';
            currentRoomCode = '';
            isPressed = false;
            audio.pause();
            audio.currentTime = 0;
            audioPlayCount = 0;
            
            masterView.classList.add('hidden');
            playerView.classList.add('hidden');
            resultsPanel.classList.add('hidden');
            homeButton.classList.add('hidden');
            startView.classList.remove('hidden');
            resultsList.innerHTML = '';
        };

        // Bấm nút TẠO
        createRoomBtn.addEventListener('click', async () => {
            isMaster = true;
            const roomCode = generateRoomCode();
            currentRoomCode = roomCode;
            
            await db.collection('rooms').doc(roomCode.toString()).set({
                status: 'inactive',
                press_times: [],
                countdown: -1,
                reset: false
            });
            
            roomCodeDisplay.textContent = roomCode;
            startView.classList.add('hidden');
            masterView.classList.remove('hidden');
            resultsPanel.classList.remove('hidden');
            homeButton.classList.remove('hidden');
            listenToRoom(roomCode);
        });

        // Bấm nút VÀO
        joinRoomBtn.addEventListener('click', () => {
            const roomCode = prompt("NHẬP MÃ:");
            if (!roomCode || isNaN(roomCode) || roomCode.length !== 1) {
                alert("Mã phòng không hợp lệ! Vui lòng nhập một chữ số.");
                return;
            }
            myName = prompt("NHẬP TÊN:");
            if (!myName) {
                alert("Vui lòng nhập tên để chơi!");
                return;
            }
            
            currentRoomCode = roomCode;
            startView.classList.add('hidden');
            masterView.classList.add('hidden'); // Đảm bảo màn hình master bị ẩn
            playerView.classList.remove('hidden');
            resultsPanel.classList.remove('hidden');
            homeButton.classList.add('hidden');
            listenToRoom(roomCode);
        });

        // Nút PLAY trên máy chủ
        playButton.addEventListener('click', async () => {
            const roomRef = db.collection('rooms').doc(currentRoomCode.toString());
            await roomRef.update({
                status: 'active',
                press_times: [],
                countdown: 3
            });

            // Chỉ máy chủ mới thực hiện đếm ngược và cập nhật lên Firestore
            let countdown = 3;
            const countdownInterval = setInterval(async () => {
                countdown--;
                await roomRef.update({ countdown: countdown });
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);

            isPressed = false;
            buzzerButton.style.backgroundColor = '#dc3545';
            audio.pause();
            audio.currentTime = 0;
        });

        // Nút BẤM của người chơi
        buzzerButton.addEventListener('click', async () => {
            if (buzzerButton.classList.contains('disabled')) {
                alert("Vòng chơi chưa bắt đầu!");
                return;
            }
            if (isPressed) {
                alert("Bạn đã bấm rồi!");
                return;
            }

            const roomRef = db.collection('rooms').doc(currentRoomCode.toString());
            const doc = await roomRef.get();
            const data = doc.data();

            if (doc.exists && data.status === 'active' && data.countdown <= 0) {
                const pressTimes = data.press_times || [];
                const hasPressed = pressTimes.some(item => item.playerName === myName);

                if (!hasPressed) {
                    await roomRef.update({
                        press_times: firebase.firestore.FieldValue.arrayUnion({
                            playerName: myName,
                            pressTime: new Date().getTime()
                        })
                    });
                    isPressed = true;
                    buzzerButton.style.backgroundColor = '#007bff';
                }
            } else {
                alert('Vòng chơi chưa bắt đầu hoặc đã kết thúc!');
            }
        });

        // Thêm sự kiện click cho nút Home
        homeButton.addEventListener('click', async () => {
            if (isMaster) {
                const roomRef = db.collection('rooms').doc(currentRoomCode.toString());
                await roomRef.update({ reset: true });
            }
        });
    </script>
</body>
</html>
